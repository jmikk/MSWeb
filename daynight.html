<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solar Lab: Verified Build</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; touch-action: none; }
        canvas { display: block; }
        .ui-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; padding: 20px; gap: 20px; }
        .glass-card { pointer-events: auto; background: rgba(15, 15, 25, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 20px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .panel-top { width: 100%; max-width: 350px; }
        .panel-bottom { width: 100%; max-width: 350px; margin-top: auto; border-bottom: 4px solid #8b5cf6; }
        .btn-season { background: #1f2937; border: 1px solid #374151; padding: 12px 8px; border-radius: 12px; font-size: 0.75rem; transition: all 0.2s; color: #9ca3af; width: 100%; font-weight: 600; }
        .btn-season.active { background: #8b5cf6; border-color: #c084fc; color: white; }
        .day-progress { height: 10px; border-radius: 5px; background: #111; overflow: hidden; display: flex; margin: 12px 0; }
        .fill-day { background: linear-gradient(90deg, #fbbf24, #f59e0b); height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .fill-night { background: linear-gradient(90deg, #2563eb, #1e40af); height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { background: #374151; height: 6px; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; margin-top: -7px; border: 2px solid white; }
    </style>
</head>
<body>

    <div class="ui-layer">
        <div class="glass-card panel-top">
            <h1 class="text-2xl font-black italic tracking-tighter mb-1">SOLAR<span class="text-purple-500">LAB</span></h1>
            <div id="dateText" class="text-2xl font-mono font-bold text-purple-400 mb-4 tracking-tight">DECEMBER 21</div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-2">Jump to Season</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setOrbit(Math.PI)" id="btn-june" class="btn-season">JUNE SOLSTICE</button>
                        <button onclick="setOrbit(1.5 * Math.PI)" id="btn-sept" class="btn-season">SEPT EQUINOX</button>
                        <button onclick="setOrbit(0)" id="btn-dec" class="btn-season active">DEC SOLSTICE</button>
                        <button onclick="setOrbit(0.5 * Math.PI)" id="btn-march" class="btn-season">MARCH EQUINOX</button>
                    </div>
                    <button onclick="togglePause()" id="btn-pause" class="btn-season mt-2 bg-gray-800 text-white border-none">PAUSE ORBIT</button>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Observer Latitude</label>
                        <span id="latDisplay" class="text-xs font-mono text-purple-400 font-bold">45°N</span>
                    </div>
                    <input type="range" id="latInput" min="-1.4" max="1.4" step="0.01" value="0.7">
                </div>
            </div>
        </div>

        <div class="glass-card panel-bottom">
            <div class="flex items-center gap-2 mb-2">
                <div id="sunPulse" class="w-3 h-3 rounded-full bg-yellow-400"></div>
                <div id="lightStatus" class="text-sm font-bold uppercase tracking-widest">DAYLIGHT</div>
            </div>
            <div class="day-progress">
                <div id="barDay" class="fill-day" style="width: 50%"></div>
                <div id="barNight" class="fill-night" style="width: 50%"></div>
            </div>
            <div id="statsText" class="text-xs font-mono text-gray-400">12.0h Day / 12.0h Night</div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, earth, earthGroup, pivot, marker, spinGroup;
        let orbitRadius = 50, orbitAngle = 0, orbitSpeed = 0.003, isPaused = false;
        let rotX = 0.6, rotY = 0.5, targetRotX = 0.6, targetRotY = 0.5, zoom = 110;
        let isDragging = false, lastX, lastY;

        const TILT = 23.5 * (Math.PI / 180);
        const MONTHS = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.15));
            const sunLight = new THREE.PointLight(0xffffff, 4, 1000);
            scene.add(sunLight);

            // Sun Mesh
            const sun = new THREE.Mesh(new THREE.SphereGeometry(6, 32, 32), new THREE.MeshBasicMaterial({ color: 0xffdd44 }));
            scene.add(sun);

            // Orbit Path
            const path = new THREE.Mesh(new THREE.RingGeometry(orbitRadius - 0.2, orbitRadius + 0.2, 128), new THREE.MeshBasicMaterial({ color: 0x222222, side: THREE.DoubleSide }));
            path.rotation.x = Math.PI / 2;
            scene.add(path);

            // Earth System Hierarchy
            pivot = new THREE.Group();
            scene.add(pivot);

            const tiltGroup = new THREE.Group();
            tiltGroup.rotation.z = -TILT; // FLIPPED: North Pole leans toward +X
            pivot.add(tiltGroup);

            spinGroup = new THREE.Group();
            tiltGroup.add(spinGroup);

            earth = new THREE.Mesh(
                new THREE.SphereGeometry(4, 64, 64),
                new THREE.MeshPhongMaterial({ color: 0x2563eb, shininess: 30, emissive: 0x050515 })
            );
            spinGroup.add(earth);

            // Equator
            const equator = new THREE.Mesh(new THREE.TorusGeometry(4.05, 0.04, 16, 100), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 }));
            equator.rotation.x = Math.PI/2;
            spinGroup.add(equator);

            // Marker & Axis
            marker = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff3b3b }));
            spinGroup.add(marker);
            spinGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 12), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.2 })));

            createStars();
            addListeners();
            animate();
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<3000; i++) pos.push((Math.random()-0.5)*1500, (Math.random()-0.5)*1500, (Math.random()-0.5)*1500);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x666666, size: 1 })));
        }

        function updateUI() {
            // Position Earth
            pivot.position.set(Math.cos(orbitAngle) * orbitRadius, 0, Math.sin(orbitAngle) * orbitRadius);

            // Date Calculation
            const dayOfOrbit = (orbitAngle % (Math.PI * 2)) / (Math.PI * 2) * 365.25;
            const date = new Date(2025, 11, 21); // Start Dec 21
            date.setDate(date.getDate() + dayOfOrbit);
            document.getElementById('dateText').innerText = `${MONTHS[date.getMonth()]} ${date.getDate()}`;

            // Latitude Logic
            const lat = parseFloat(document.getElementById('latInput').value);
            marker.position.y = lat * 4;
            const r = Math.sqrt(Math.max(0, 16 - marker.position.y**2));
            marker.position.z = r; marker.position.x = 0;
            document.getElementById('latDisplay').innerText = `${Math.abs(Math.round(lat*64))}°${lat >= 0 ? 'N' : 'S'}`;

            // Daylight Logic
            const mPos = new THREE.Vector3(); marker.getWorldPosition(mPos);
            const ePos = new THREE.Vector3(); earth.getWorldPosition(ePos);
            const isDay = mPos.clone().sub(ePos).normalize().dot(new THREE.Vector3().sub(ePos).normalize()) > 0;
            
            document.getElementById('lightStatus').innerText = isDay ? "Daytime" : "Nighttime";
            document.getElementById('lightStatus').className = isDay ? "text-sm font-bold text-yellow-500" : "text-sm font-bold text-blue-400";
            document.getElementById('sunPulse').className = isDay ? "w-3 h-3 rounded-full bg-yellow-400 animate-pulse" : "w-3 h-3 rounded-full bg-blue-700";

            // Corrected Ratio Math
            const tiltEff = -Math.cos(orbitAngle) * lat * 0.85;
            const dayP = Math.min(100, Math.max(0, 50 + (tiltEff * 48)));
            document.getElementById('barDay').style.width = dayP + "%";
            document.getElementById('barNight').style.width = (100 - dayP) + "%";
            document.getElementById('statsText').innerText = `${(dayP * 0.24).toFixed(1)}h Day / ${((100-dayP)*0.24).toFixed(1)}h Night`;
        }

        function setOrbit(val) { 
            orbitAngle = val; 
            document.querySelectorAll('.btn-season').forEach(b => b.classList.remove('active'));
            if(val === 0) document.getElementById('btn-dec').classList.add('active');
            if(val === Math.PI) document.getElementById('btn-june').classList.add('active');
        }
        
        function togglePause() { 
            isPaused = !isPaused; 
            document.getElementById('btn-pause').innerText = isPaused ? "RESUME ORBIT" : "PAUSE ORBIT";
        }

        function addListeners() {
            window.addEventListener('mousedown', () => isDragging = true);
            window.addEventListener('mouseup', () => isDragging = false);
            window.addEventListener('mousemove', (e) => {
                if(isDragging) { targetRotY += e.movementX * 0.005; targetRotX += e.movementY * 0.005; }
            });
            window.addEventListener('wheel', (e) => zoom = Math.max(50, Math.min(300, zoom + e.deltaY * 0.1)));
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isPaused) orbitAngle += orbitSpeed;
            spinGroup.rotation.y += 0.04;
            rotX += (targetRotX - rotX) * 0.1; rotY += (targetRotY - rotY) * 0.1;
            camera.position.set(zoom * Math.sin(rotY) * Math.cos(rotX), zoom * Math.sin(rotX), zoom * Math.cos(rotY) * Math.cos(rotX));
            camera.lookAt(0, 0, 0);
            updateUI();
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
